"""
–ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞.
"""

import sys
import os
import logging

from config import Settings
from storage import VectorDatabase, UserDatabase
from ai_processor import OpenAIClient
from ai_processor import ResponseGenerator as OpenAIResponseGenerator
from ai_gigachat_processor import GigaChatClient
from ai_gigachat_processor import ResponseGenerator as GigaChatResponseGenerator
from memory_manager import PromptBuilder, ContextRetriever
from dialog_controller import SessionManager
from interface import TelegramBot
from utils import setup_logging


def validate_environment():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫."""
    print("=" * 60)
    print("–ü–†–û–í–ï–†–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø")
    print("=" * 60)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    chroma_dir = "./chroma_db"
    if not os.path.exists(chroma_dir):
        print(f"\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è {chroma_dir} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        print("üí° –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π:")
        print("   python -m tools.ingest_documents")
        sys.exit(1)
    
    print(f"‚úì –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω–∞: {chroma_dir}")
    print()


def initialize_components(settings: Settings):
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã.
    
    Args:
        settings: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        
    Returns:
        –ö–æ—Ä—Ç–µ–∂ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    """
    logger = logging.getLogger(__name__)
    
    logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...")
    
    # 1. Storage - –•—Ä–∞–Ω–∏–ª–∏—â–∞
    logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â...")
    vector_db = VectorDatabase(
        persist_directory=settings.chroma_persist_dir,
        collection_name=settings.chroma_collection,
        openai_api_key=settings.openai_api_key
    )
    vector_db.get_or_create_collection()
    
    user_db = UserDatabase(storage_path="./user_data.json")
    
    # 2. AI Processor - –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –ò–ò
    logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ ({settings.ai_provider})...")
    
    if settings.ai_provider == "openai":
        openai_client = OpenAIClient(
            api_key=settings.openai_api_key,
            model=settings.openai_model,
            temperature=settings.openai_temperature,
            max_tokens=settings.openai_max_tokens
        )
        response_generator = OpenAIResponseGenerator(openai_client=openai_client)
        logger.info(f"‚úì OpenAI –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–º–æ–¥–µ–ª—å: {settings.openai_model})")
        
    elif settings.ai_provider == "gigachat":
        from ai_gigachat_processor import GigaChatConfig
        
        gigachat_config = GigaChatConfig(
            authorization_key=settings.gigachat_authorization_key,
            model=settings.gigachat_model,
            temperature=settings.gigachat_temperature,
            max_tokens=settings.gigachat_max_tokens,
            verify_ssl=settings.gigachat_verify_ssl
        )
        
        gigachat_client = GigaChatClient(config=gigachat_config)
        response_generator = GigaChatResponseGenerator(gigachat_client=gigachat_client)
        logger.info(f"‚úì GigaChat –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–º–æ–¥–µ–ª—å: {settings.gigachat_model})")
        
    else:
        raise ValueError(f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π AI provider: {settings.ai_provider}")
    
    # 3. Memory Manager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
    logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–∞–º—è—Ç–∏...")
    prompt_builder = PromptBuilder(
        system_prompt=response_generator.system_prompt
    )
    
    context_retriever = ContextRetriever(
        vector_db=vector_db,
        n_results=settings.rag_n_results
    )
    
    # 4. Dialog Controller - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞–º–∏
    logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤...")
    session_manager = SessionManager(
        session_timeout=settings.session_timeout
    )
    
    # 5. Interface - Telegram –±–æ—Ç
    logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –±–æ—Ç–∞...")
    telegram_bot = TelegramBot(
        token=settings.telegram_token,
        session_manager=session_manager,
        context_retriever=context_retriever,
        response_generator=response_generator,
        user_db=user_db,
        vector_db=vector_db
    )
    
    logger.info("–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
    
    return telegram_bot


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    print("=" * 60)
    print("TELEGRAM RAG BOT - –ó–ê–ü–£–°–ö")
    print("=" * 60)
    
    try:
        # 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        setup_logging(level="INFO")
        logger = logging.getLogger(__name__)
        
        # 2. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        logger.info("–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...")
        try:
            settings = Settings.from_env()
        except ValueError as e:
            print(f"\n‚ùå –û–®–ò–ë–ö–ê: {e}")
            print("\nüí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
            print("   TELEGRAM_BOT_TOKEN - —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞")
            print("   OPENAI_API_KEY - API –∫–ª—é—á OpenAI")
            print("\n–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å —ç—Ç–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏.")
            sys.exit(1)
        
        # 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if not settings.validate():
            print("\n‚ùå –û–®–ò–ë–ö–ê: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!")
            sys.exit(1)
        
        print("‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")
        
        # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        validate_environment()
        
        # 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        print("=" * 60)
        print("–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–ú–ü–û–ù–ï–ù–¢–û–í")
        print("=" * 60)
        
        telegram_bot = initialize_components(settings)
        
        print("\n‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!")
        print("=" * 60)
        
        # 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        print("\nüí¨ –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram –∏ –Ω–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!")
        print("üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C\n")
        
        telegram_bot.run()
    
    except KeyboardInterrupt:
        print("\n\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(0)
    
    except Exception as e:
        logger = logging.getLogger(__name__)
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()

